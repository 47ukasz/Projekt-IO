@model projekt_io.DTOs.ChatDetailsDto

@{
  ViewData["Title"] = "Czat";
  var myId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
  var receiver = Model.Chat.Creator.Id == myId ? Model.Chat.Owner : Model.Chat.Creator;
  var me = Model.Chat.Creator.Id == myId ? Model.Chat.Creator : Model.Chat.Owner; 
  
  var myInitials = $"{(me.FirstName?.FirstOrDefault() ?? '?')}{(me.LastName?.FirstOrDefault() ?? '?')}".ToUpper();
  var receiverInitials = $"{(receiver.FirstName?.FirstOrDefault() ?? '?')}{(receiver.LastName?.FirstOrDefault() ?? '?')}".ToUpper();
}

@section Styles {
  <link rel="stylesheet" href="~/css/main.css" />
  <link rel="stylesheet" href="~/css/reset.css" />
  <link rel="stylesheet" href="~/css/home.css" />
  <link rel="stylesheet" href="~/css/profile.css" />
  <link rel="stylesheet" href="~/css/messages.css" />
}

<div class="header">
    <p class="header-app-location">
        <span><i class="fa-solid fa-house" style="color: #757575"></i></span>
        <a href="">Strona główna</a>
        >
        <a href="">Wiadomości</a>
        >
        <a href="" class="current">@receiver.FirstName @receiver.LastName</a>
    </p>
    <div class="header-back">
        <i class="fa-solid fa-arrow-left-long" style="color: #757575"></i>
        <a> Wróć do zgłoszenia </a>
    </div>
</div>
<div class="chat-wrapper">
  <div class="chat-header">
    <div class="chat-user-avatar">
      <p>@receiverInitials</p>
    </div>
    <div class="chat-user-info">
      <p class="chat-user-name">@receiver.FirstName @receiver.LastName</p>
      <p class="chat-reason">
        <i class="fa-solid fa-shield-dog"></i> W sprawie: @Model.Chat.TargetTitle
      </p>
    </div>
  </div>
  <div class="chat-content" id="messagesBox">
    <p class="chat-createdAt">@Model.Chat.CreatedAt.ToString("D")</p>
    <p class="chat-warning">
      <span>
        <i class="fa-solid fa-circle-exclamation"></i>
      </span>
      Nigdy nie ufaj drugiej osobie. Zawsze poproś o potwierdzienie informacji.
    </p>
    @foreach (var m in Model.Messages) {
      <div class="message-wrapper @(m.IsMine ? "right" : "left")">
        @if (!m.IsMine) {
            <div class="message-avatar">
                <p>@receiverInitials</p>
            </div>
        } else {
            <div class="message-avatar">
                <p>@myInitials</p>
            </div>
        }
        <div class="message-box">
            <p class="message">
                @m.Content
            </p>
            <p class="message-createdAt">@m.SentAt.ToString("HH:mm")</p>
        </div>
      </div>
    }
  </div>
  <div class="chat-footer">
      <input
          id="chatInput"
          type="text"
          class="chat-message-input"
          placeholder="Napisz wiadomość..."
      />
      <input type="hidden" id="myId" value="@myId" />
      <input type="hidden" id="creatorId" value="@Model.Chat.Creator.Id" />
      <input type="hidden" id="ownerId" value="@Model.Chat.Owner.Id" />

      <input type="hidden" id="creatorInitials" value="@($"{(Model.Chat.Creator.FirstName?.FirstOrDefault() ?? '?')}{(Model.Chat.Creator.LastName?.FirstOrDefault() ?? '?')}".ToUpper())" />

      <input type="hidden" id="ownerInitials"
             value="@($"{(Model.Chat.Owner.FirstName?.FirstOrDefault() ?? '?')}{(Model.Chat.Owner.LastName?.FirstOrDefault() ?? '?')}".ToUpper())" />

      <input type="hidden" id="chatId" value="@Model.Chat.ChatId" />
    <button id="sendBtn" class="chat-sent-button">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</div>
<div id="chatError"></div>

@section Scripts {
    <!-- CDN SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>

    <script>
        (function () {
            const chatId = document.getElementById("chatId").value;
            const input = document.getElementById("chatInput");
            const sendBtn = document.getElementById("sendBtn");
            const box = document.getElementById("messagesBox");
            const err = document.getElementById("chatError");

            // id zalogowanego usera (wstawiane przez Razor)
            const myId = document.getElementById("myId").value;
            const creatorId = document.getElementById("creatorId")?.value;
            const ownerId = document.getElementById("ownerId")?.value;
            const creatorInitials = document.getElementById("creatorInitials")?.value || "??";
            const ownerInitials = document.getElementById("ownerInitials")?.value || "??";

            function initialsFor(senderId) {
                if (senderId === creatorId) return creatorInitials;
                if (senderId === ownerId) return ownerInitials;
                return "??";
            }

            function appendMessage(content, sentAt, isMine, initials = "??") {
                const wrapper = document.createElement("div");
                wrapper.classList.add("message-wrapper");
                wrapper.classList.add(isMine ? "right" : "left");

                // avatar
                const avatar = document.createElement("div");
                avatar.classList.add("message-avatar");

                const avatarText = document.createElement("p");
                avatarText.textContent = initials;
                avatar.appendChild(avatarText);

                // box wiadomości
                const boxEl = document.createElement("div");
                boxEl.classList.add("message-box");

                const messageP = document.createElement("p");
                messageP.classList.add("message");
                messageP.textContent = content;

                const timeP = document.createElement("p");
                timeP.classList.add("message-createdAt");

                const dt = new Date(sentAt);
                timeP.textContent = isNaN(dt.getTime())
                    ? ""
                    : dt.toLocaleTimeString("pl-PL", {
                        hour: "2-digit",
                        minute: "2-digit",
                    });

                boxEl.appendChild(messageP);
                boxEl.appendChild(timeP);

                // kolejność elementów (lewo/prawo)
                if (isMine) {
                    wrapper.appendChild(avatar);
                    wrapper.appendChild(boxEl);
                } else {
                    wrapper.appendChild(avatar);
                    wrapper.appendChild(boxEl);
                }

                box.appendChild(wrapper);

                // scroll na dół
                box.scrollTop = box.scrollHeight;
            }

            // start od razu na dole listy
            box.scrollTop = box.scrollHeight;

            // połączenie z hubem
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/chat")
                .withAutomaticReconnect()
                .build();

            // odbiór wiadomości (broadcast z serwera)
            connection.on("ReceiveMessage", (msg) => {
                if (!msg) return;
                if (msg.chatId !== chatId) return;

                const isMine = msg.senderId === myId;
                appendMessage(msg.content, msg.sentAt, isMine, initialsFor(msg.senderId));
            });

            connection.onreconnected(async () => {
                try {
                    await connection.invoke("JoinChat", chatId);
                    err.textContent = "";
                } catch (e) {
                    err.textContent = "Błąd ponownego połączenia czatu.";
                    console.error(e);
                }
            });
            
            async function start() {
                try {
                    await connection.start();
                    await connection.invoke("JoinChat", chatId);
                    err.textContent = "";
                } catch (e) {
                    err.textContent = "Błąd połączenia czatu.";
                    console.error(e);
                }
            }

            // wysyłanie
            async function send() {
                const text = (input.value || "").trim();
                if (!text) return;

                sendBtn.disabled = true;
                err.textContent = "";

                try {
                    await connection.invoke("SendMessage", chatId, text);
                    input.value = "";
                    input.focus();
                } catch (e) {
                    err.textContent = "Nie udało się wysłać wiadomości.";
                    console.error(e);
                } finally {
                    sendBtn.disabled = false;
                }
            }

            sendBtn.addEventListener("click", send);

            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    send();
                }
            });

            window.addEventListener("beforeunload", () => {
                connection.invoke("LeaveChat", chatId).catch(() => { });
            });

            start();
        })();
    </script>
}